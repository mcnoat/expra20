<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Expra experiment</title>
	<script src="jsPsych/jspsych.js"></script>
	<script src="jsPsych/plugins/jspsych-html-keyboard-response.js"></script>
	<script src="jsPsych/plugins/jspsych-instructions.js"></script>
	<script src="jsPsych/plugins/jspsych-survey-html-form.js"></script>
	<script src="jsPsych/plugins/jspsych-survey-multi-choice.js"></script>
	<script src="jsPsych/plugins/jspsych-survey-text.js"></script>
	<link href="jsPsych/css/jspsych.css" rel="stylesheet" type="text/css"></link>
</head>
<body></body>
<script>
	let age = {},
		attract_instr = {},
		attract_rating = {},
		conf_instruct = {},
		conf_rt = {},
		fixation = {},
		gender = {},
		language = {},
		latin = {},
		letter_display = {},
		self_esteem = {},
		subj_code = {},
		welcome = {},
		scale = [],
		timeline = [],
		widgets = [],
		subj_id = '';

	function saveData(name, data){
		let xhr = new XMLHttpRequest();
		xhr.open('POST', 'write_data.php'); // 'write_data.php' is the path to the php file described above.
		xhr.setRequestHeader('Content-Type', 'application/json');
		xhr.send(JSON.stringify({filename: name, filedata: data}));
	}

	function generateAlphabet() {
  		let alphabet = [];
  		let start = 'A'.charCodeAt(0);
  		let last  = 'Z'.charCodeAt(0);
  		for (let i = start; i <= last; i++) {
    		alphabet.push(String.fromCharCode(i));
  		}
		return alphabet;
	}

	function underline(letter) {
		return '<u>' + letter + '</u>'
	}

	subj_id = jsPsych.randomization.randomID()

	welcome = {
		type: 'instructions',
		pages: [`
			Willkommen zum Experiment vom Expra B!<br>
			Drücken Sie die rechte Pfeiltaste, um mit dem Experiment fort zu fahren.
			`]
	};
	widgets.push(welcome);

	age = {
		type: "survey-text",
		questions: [
				{prompt: "Wie alt sind Sie?",
				placeholder: 'z.B. 20',
				name: 'age'}
			],
	};
	widgets.push(age);	

	gender = {
		type: "survey-multi-choice",
		questions: [
			{prompt: `<p>Zu welchem Geschlecht fühlen Sie sich zugehörig?<br>
				Unter "divers" verstehen wir hier sämtliche Geschlechtsidentitäten, die nicht in das "männlich-weiblich"-Schema passen.</p>`,
			name: "gender",
			options: ["männlich", "weiblich", "divers"]}
			]
	};
	widgets.push(gender);

	language = {
		type: 'survey-text',
		questions: [
				{prompt: 'Was ist Ihre Muttersprache?',
				placeholder: 'z.B. deutsch, englisch, chinesisch...',
				name: 'language'}
			]
	};
	widgets.push(language);

	latin = {
		type: 'survey-multi-choice',
		questions: [
				{prompt: 'Benutzt Ihre Muttersprache die Buchstaben A bis Z aus dem lateinisch-römischen Alphabet?',
				options: ['ja', 'nein']
				}
			],
		name: 'latin'
	};
	widgets.push(latin);

	subj_code = {
		type: 'survey-text',
		questions: [
			{prompt: `
			<p>Im Folgenden bitten wir Sie einen sechsstelligen persönlichen Code zu erstellen, den Sie durch Beantwortung der nachstehenden Fragen jederzeit wieder generieren könnten.</p>
			<ol>
				<li>Wie ist der Anfangsbuchstabe Ihres ersten Vornamens? z.B. bei Elke Alena Meier ein „E“</li>
				<li>Wie lautet Ihr Geburtsdatum?
					Geben Sie nur das Datum des Tages an, z.B. bei 04.03.2001 wäre es „04“</li>
				<li>Aus wie vielen Buchstaben besteht Ihr Nachname? z.B. „Meier“ hat 05 Buchstaben</li>
				<li>Wie ist der Anfangsbuchstaben Ihres Nachnamens? z.B. „Meier“ wäre ein „M“</li>
			</ol>
			`,
			placeholder: 'Beispiel-Code von „Elke Alena Meier“: E0405M',
			name: 'subj_code'}
		]
	};
	widgets.push(subj_code);

	attract_instr = {
		type: 'instructions',
		pages: [`
			<p><b>Bitte lesen Sie sich die folgenden Instruktionen aufmerksam durch!</b></p>
			<p>Im Folgenden wird es um Ihr ästhetisches Empfinden in Bezug auf einfache visuelle Reize gehen.
			In diesem Fall haben wir Buchstaben gewählt.
			Wahrscheinlich sind Sie es nicht gewohnt, Buchstaben zu bewerten.
			Wir möchten Sie aber trotzdem darum bitten, da Studien gezeigt haben, dass die spätere Erfassung menschlicher Gedanken und Emotionen dadurch erleichtert wird.
			Im Folgenden finden Sie die einzelnen Buchstaben des Alphabets.
			Schreiben Sie bitte hinter jedem Buchstaben eine Zahl von 1 bis 6.
			Hiermit drücken Sie aus, wie sehr Ihnen der jeweilige Buchstabe gefällt ( <b>1 = gefällt mir ganz und gar nicht</b>, <b>6 = gefällt mir sehr</b>).<br>
			Entscheiden Sie bitte bei jedem Buchstaben spontan, also ohne lange zu überlegen.</p>
			<p>Nachdem Sie diese Instruktionen aufmerksam gelesen haben, drücken Sie bitte die rechte Pfeiltaste, um fort zu fahren.</p>
			`],
	};
	widgets.push(attract_instr);

	let attract_alphabet = [],
		attract_questions = [],
		attract_question = {};

	attract_alphabet = generateAlphabet();
	attract_alphabet = jsPsych.randomization.shuffle(attract_alphabet);
	scale = [1, 2, 3, 4, 5, 6];
	for (const letter of attract_alphabet){
		attract_question = {
			prompt: '<b>'+letter+'</b>',
			options: scale,
			horizontal: true,
			name: 'attract' + letter
		};
		attract_questions.push(attract_question);
	}

	attract_rating = {
		type: 'survey-multi-choice',
		questions: attract_questions
	};

	widgets.push(attract_rating);

	scale = ['Trifft gar nicht zu', 'Trifft eher nicht zu', 'Trifft eher zu', 'Trifft voll und ganz zu']
	self_esteem = {
		type: 'survey-multi-choice',
		questions: [
			{prompt: '<b>Alles in allem bin ich mit mir selbst zufrieden.</b>',
			name: 'rosenberg01'},
			{prompt: '<b>Hin und wieder denke ich, dass ich gar nichts tauge.</b>',
			name: 'rosenberg02'},
			{prompt: '<b>Ich besitze eine Reihe guter Eigenschaften.</b>',
			name: 'rosenberg03'},
			{prompt: '<b>Ich kann vieles genauso gut wie die meisten anderen Menschen auch.</b>',
			name: 'rosenberg04'},
			{prompt: '<b>Ich fürchte, es gibts nicht viel, worauf ich Stolz sein kann.</b>',
			name: 'rosenberg05'},
			{prompt: '<b>Ich fühle mich von Zeit zu Zeit richtig nutzlos.</b>',
			name: 'rosenberg06'},
			{prompt: '<b>Ich halte mich für einen wertvollen Menschen, jedenfalls bin ich nicht weniger wertvoll als andere auch.</b>',
			name: 'rosenberg07'},
			{prompt: '<b>Ich wünschte, ich könnte vor mir selbst mehr Achtung haben.</b>',
			name: 'rosenberg08'},
			{prompt: '<b>Alles in allem neige ich dazu, mich für einen Versager zu halten.</b>',
			name: 'rosenberg09'},
			{prompt: '<b>Ich habe eine positive Einstellung zu mir selbst gefunden.</b>',
			name: 'rosenberg10'}
		],
		randomize_question_order: true
	};
	for (const question of self_esteem['questions']){
		question['options'] = scale;
	}
	widgets.push(self_esteem);

	conf_instr = {
		type: 'instructions',
		pages: [`
			<p>In dem folgenden Abschnitt des Experiments werden Ihnen ein Kreuz und  Buchstaben für einen kurzen Augenblick präsentiert.
			Pro Durchgang wird es einen Buchstaben als "Zielbuchstaben" geben, der Ihnen am Anfang präsentiert wird.
			Diesen sollen Sie wieder erkennen.
			Anschließend, nach einem Kreuz, werden Ihnen zwei Buchstaben angezeigt, von denen einer der Standard ist.
			Bitte nutzen Sie für links die X- oder für rechts die N-Taste um anzugeben, ob der Ziel-Buchstabe auf der linken oder rechten Seite zu sehen ist.<br>
			Bitte entscheiden Sie so schnell und so genau wie möglich.
			Denken Sie nicht zu viel über ihre Entscheidung nach, sondern folgen Sie Ihrem Instinkt.</p>
			<p>Nachdem Sie diese Instruktionen gelesen haben, drücken Sie bitte die rechte Pfeiltaste, um fort zu fahren.</p>
			`]
	};
	widgets.push(conf_instr);


	for (const widget of widgets){
		widget['button_label'] = 'Weiter';
		if (widget['questions']) {
			for (const question of widget['questions']){
				question['required'] = true;
			}
		}
		timeline.push(widget);
	}

	let blocks = [],
		dist_randomizer = [],
		fav_func = function(){},
		control1 = '',
		control2 = '',
		fore = '',
		sur = '';
	
	dist_randomizer = generateAlphabet();
	dist_randomizer = jsPsych.randomization.shuffle(dist_randomizer);

	function getTargets() {
		let json_arry = [],
			randomizer_i = 0,
			obj = {},
			control1 = '',
			control2 = '',
			fore = '',
			subj_code = '',
			sur = '';
		
		json_arr = jsPsych.data.get().filter({trial_type: 'survey-text'}).select('responses').values; 
		for (const json of json_arr) {
			obj = JSON.parse(json);
			if ('subj_code' in obj){
				subj_code = obj.subj_code;
			}
		}

		fore = subj_code[0];
		sur = subj_code.slice(-1);

		//select the first four elements of the randomizer
		randomizer_slice = dist_randomizer.slice(0, 4);
		//check whether target is in slice and remove it if necessary
		for (const letter of [fore, sur]){
			if (randomizer_slice.includes(letter)){
				let i = randomizer_slice.indexOf(letter);
				randomizer_slice.splice(i, 1);
			}
		}
		control1 = randomizer_slice[0];
		control2 = randomizer_slice[1];

		//order in accordance with the order of presentation during experiment
		return [control1, fore, control2, sur]
	}

	//array of 4 empty arrays
	blocks = [ [], [], [], [] ];
	
	for (let block_i = 0; block_i < 4; block_i++) {
		let dist_alphabet = [];

		dist_alphabet = generateAlphabet();
		dist_alphabet = jsPsych.randomization.shuffle(dist_alphabet);

		for (let trial_i = 0; trial_i < 25; trial_i++) {
			fav_func = function() {
				let two_letters = [],
					id_obj = {},
					distractor = '',
					subj_code = '',
					target = '',
					html_display = '',
					id_json = '';
				
				if (block_i===0 && trial_i===0){
					[control1, fore, control2, sur] = getTargets();
				}

				switch (block_i) {
					case 0:
						target = control1;
						break;
					case 1:
						target = fore;
						break;
					case 2:
						target = control2;
						break;
					case 3:
						target = sur;
						break;
				}
				
				//do not compare letter to itself
				if (dist_alphabet.includes(target)) {
					dist_alphabet.splice(dist_alphabet.indexOf(target), 1);
				}
				
				distractor = dist_alphabet[trial_i];
				
				if (Math.random() < .5) {
					two_letters = [target, distractor]
				}
				else {
					two_letters = [distractor, target]
				}
				
				html_display = '<div style="font-size:60px;">'+two_letters[0]+'&emsp;'+two_letters[1]+'</div>';
				return html_display;
				}
				
			blocks[block_i].push({stimulus: fav_func})
		}
	}

	letter_display = {
		type: 'html-keyboard-response',
		stimulus: jsPsych.timelineVariable('stimulus'),
		choices: ['x', 'n']
	};
	
	fixation = {
		type: 'html-keyboard-response',
		stimulus: '<div style="font-size:60px;">+</div>',
		choices: jsPsych.NO_KEYS,
		trial_duration: 1000
	};
	
	let target_instructs = [],
		instruct_func = function(){};

	for (let i=0; i<4; i++) {
		instruct_func = function() {
			let instruct = ''
				target = '';

			target = getTargets()[i];
			instruct = `
				Ihr Target für diese Runde ist ${target}.<br>
				Drücken Sie eine beliebige Taste, um fort zu fahren.
				`

			return instruct; 
		}
		target_instructs.push(instruct_func);
	}


	let conf_block = {},
		target_tell = {};

	for (let i=0; i<4; i++) {
		target_tell = {
			type: 'html-keyboard-response',
			stimulus: target_instructs[i]
		};
		timeline.push(target_tell);

		conf_block = {
			timeline: [fixation, letter_display],
			timeline_variables: blocks[i]
		};
		timeline.push(conf_block);
	}

	jsPsych.init({
		timeline: timeline,
		on_finish: function() {
			jsPsych.data.displayData();
			saveData(subj_id, jsPsych.data.get().csv());
			}
		}
	)
	</script>
</html>